<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUIZ V41 - SCROLLABLE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e2024 0%, #23252b 100%);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --text-main: #e0e0e0;
            --text-muted: #9ca3af;
            --text-highlight: #ffffff;
            --accent-primary: #6c5ce7; 
            --accent-success: #00b894;
            --accent-danger: #ff7675;
            --accent-warning: #fdcb6e;
            --radius-md: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            /* CAMBIO CLAVE: Permitir scroll natural y m√°rgenes amplios */
            min-height: 100vh;
            padding: 30px 15px 60px 15px; 
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Scroll activado */
            font-size: 14px;
        }

        /* --- PANELES --- */
        /* Ahora los paneles crecen con el contenido, no tienen scroll interno */
        .panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            box-shadow: var(--glass-shadow);
            display: flex; 
            flex-direction: column;
            margin-bottom: 20px;
            overflow: visible; /* Dejar que el contenido estire el panel */
        }

        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding: 0 5px;
        }
        .app-title { font-weight: 800; font-size: 1.1rem; color: var(--text-highlight); }

        /* --- BOTONES Y CONTROLES --- */
        .btn {
            border: none; padding: 14px; cursor: pointer;
            border-radius: var(--radius-md);
            font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.9rem;
            text-transform: uppercase; width: 100%; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-default { background: rgba(255,255,255,0.1); color: white; }
        .btn-primary { background: var(--accent-primary); color: white; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); }
        .btn-danger { background: rgba(255, 118, 117, 0.15); color: var(--accent-danger); border: 1px solid rgba(255, 118, 117, 0.3); }

        .filter-toggle {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 8px 14px;
            font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
            display: flex; align-items: center; gap: 6px; cursor: pointer;
        }
        .filter-toggle.active {
            background: var(--accent-warning); color: #1e2024; border-color: var(--accent-warning);
        }

        /* --- HOME --- */
        .cat-grid { 
            display: grid; 
            grid-template-columns: 1fr; /* Una columna en m√≥vil */
            gap: 15px; 
            padding: 20px; 
        }
        @media(min-width: 600px) { .cat-grid { grid-template-columns: 1fr 1fr; } }

        .cat-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: var(--radius-md); padding: 20px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 100px;
        }
        .cat-status-badge { display: inline-flex; align-items: center; gap: 8px; font-size: 0.7rem; font-weight: 700; padding: 5px 10px; border-radius: 20px; background: rgba(0,0,0,0.3); width: fit-content; margin-top: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .st-grey .status-dot { background: #636e72; } .st-grey { color: #9ca3af; border: 1px solid #636e72; }
        .st-yellow .status-dot { background: var(--accent-warning); } .st-yellow { color: var(--accent-warning); border: 1px solid var(--accent-warning); }
        .st-green .status-dot { background: var(--accent-success); } .st-green { color: var(--accent-success); border: 1px solid var(--accent-success); }

        /* --- QUIZ LAYOUT --- */
        /* Estructura vertical simple */
        .quiz-container { display: flex; flex-direction: column; gap: 20px; }

        .question-text { 
            font-size: 1.1rem; font-weight: 600; line-height: 1.5; color: white; 
            margin-bottom: 20px; padding: 0 5px;
        }

        /* OPCIONES M√ÅS COMPACTAS */
        .quiz-option {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px;
            padding: 12px 15px; /* Menos padding vertical */
            margin-bottom: 8px; /* Menos separaci√≥n */
            cursor: pointer; font-size: 0.95rem; line-height: 1.3;
            display: flex; align-items: center;
        }
        .quiz-option.selected { background: rgba(108, 92, 231, 0.2); border-color: var(--accent-primary); color: white; font-weight: 600; }
        .quiz-option.correct { background: rgba(0, 184, 148, 0.2); border-color: var(--accent-success); color: #55efc4; }
        .quiz-option.incorrect { background: rgba(255, 118, 117, 0.2); border-color: var(--accent-danger); color: #ff7675; }
        .quiz-option.disabled { opacity: 0.9; pointer-events: none; }

        /* --- NAV GRID (BOTTOM) --- */
        .nav-panel { padding: 20px; }
        .stats-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-box { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 10px; text-align: center; border-radius: 8px; }
        .stat-num { font-size: 1.5rem; font-weight: 800; display: block; }
        
        .nav-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(38px, 1fr)); gap: 6px; 
            max-height: 200px; overflow-y: auto; /* Scroll solo si hay much√≠simas preguntas */
        }
        .grid-item { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.8rem; color: #888; font-weight: 600; }
        .grid-item.active { border: 2px solid white; color: white; background: transparent; }
        .grid-item.correct { background: var(--accent-success); color: black; }
        .grid-item.incorrect { background: var(--accent-danger); color: white; }
        .grid-item.skipped { background: #111; color: #333; border: 1px solid #222; }

        /* --- UTILS --- */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        input { font-size: 16px !important; } /* Fix iOS zoom */
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <div class="top-bar">
            <div class="app-title">QUIZ V41</div>
        </div>
        <div class="panel" style="padding: 20px;">
            <h2 style="text-align:center; margin-bottom:20px; font-size:1.4rem;">Elige Categor√≠a</h2>
            <div id="home-cat-list" class="cat-grid"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-default" onclick="App.showEditor()">Gestionar</button>
                <button class="btn btn-danger" onclick="DataManager.nuke()">Reset</button>
            </div>
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="top-bar">
            <button class="btn btn-default" style="width:auto; padding: 8px 12px; font-size:0.7rem;" onclick="App.goHome()">SALIR</button>
            <button id="btn-filter-img" class="filter-toggle" onclick="QuizEngine.toggleImgFilter()"><span>üëÅÔ∏è</span> TODO</button>
        </div>

        <div class="quiz-container">
            <div class="panel" style="padding: 20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:var(--text-muted); font-size:0.8rem; font-weight:700;">
                    <span id="quiz-cat-name">CAT</span>
                    <span id="quiz-progress">1 / X</span>
                </div>
                
                <div id="quiz-img-warn" style="display:none; padding:10px; background:rgba(108,92,231,0.1); border:1px dashed var(--accent-primary); border-radius:8px; margin-bottom:15px; color:#a29bfe; font-size:0.85rem;">
                    üì∑ <strong>Requiere Imagen</strong> (Ver PDF)
                </div>

                <div id="quiz-question" class="question-text">...</div>
                <div id="quiz-options"></div>

                <div style="margin-top:20px;">
                    <button id="btn-action" class="btn btn-primary">CONFIRMAR</button>
                </div>
            </div>

            <div class="panel nav-panel">
                <div class="stats-row">
                    <div class="stat-box" style="border-color:rgba(0,184,148,0.3);"><span id="stat-ok" class="stat-num" style="color:var(--accent-success)">0</span><span class="stat-lbl">Bien</span></div>
                    <div class="stat-box" style="border-color:rgba(255,118,117,0.3);"><span id="stat-fail" class="stat-num" style="color:var(--accent-danger)">0</span><span class="stat-lbl">Mal</span></div>
                </div>
                <div id="nav-grid" class="nav-grid"></div>
                <button class="btn btn-danger" style="margin-top:15px; font-size:0.8rem; padding:10px;" onclick="QuizEngine.resetProgress()">REINICIAR CATEGOR√çA</button>
            </div>
        </div>
    </div>

    <div id="screen-editor" class="screen">
        <div class="top-bar">
            <div class="app-title">GESTOR</div>
            <button class="btn btn-default" style="width:auto; padding:8px 12px;" onclick="App.goHome()">VOLVER</button>
        </div>
        <div class="panel" style="padding:20px;">
            <h3 style="margin-top:0;">Importar Preguntas</h3>
            <textarea id="bulk-input" style="width:100%; height:150px; background:rgba(0,0,0,0.3); border:1px solid #444; color:white; padding:10px; border-radius:8px; margin-bottom:10px;" placeholder="Pega el JSON aqu√≠..."></textarea>
            <select id="import-target" style="width:100%; padding:10px; background:#222; color:white; border:1px solid #444; border-radius:8px; margin-bottom:10px;"></select>
            <button class="btn btn-primary" onclick="Editor.processBulk()">PROCESAR JSON</button>
            
            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
            
            <h3>Crear Categor√≠a</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-cat-input" placeholder="Nombre..." style="background:#222; border:1px solid #444; color:white; padding:10px; border-radius:8px; flex:1;">
                <button class="btn btn-default" style="width:auto;" onclick="Editor.createCategory()">+</button>
            </div>
            <div id="editor-cat-list" style="margin-top:15px; display:flex; flex-direction:column; gap:5px;"></div>
        </div>
    </div>

<script>
// --- MISMA L√ìGICA DE DATOS Y FILTRO GHOST QUE TE FUNCIONA ---
const DataManager = {
    key: 'DB_QUIZ_V29', db: {},
    init() {
        const raw = localStorage.getItem(this.key);
        if(raw) try { this.db = JSON.parse(raw); } catch(e) { this.db = {}; }
    },
    save() { localStorage.setItem(this.key, JSON.stringify(this.db)); },
    createCat(n) { if(!n || this.db[n]) return; this.db[n] = []; this.save(); },
    deleteCat(n) { if(confirm("¬øBorrar?")) { delete this.db[n]; localStorage.removeItem('SESSION_'+n); this.save(); } },
    importJSON(t, j) {
        try {
            const d = JSON.parse(j);
            if(t === '__AUTO__' && Array.isArray(d)) d.forEach(x => { if(x.cat) this.db[x.cat] = x.data; });
            else if (this.db[t]) this.db[t] = this.db[t].concat(d);
            this.save(); return true;
        } catch(e) { alert("JSON Mal"); return false; }
    },
    nuke() { if(confirm("¬øReset Total?")) { localStorage.clear(); location.reload(); } },
    getCats() { return Object.keys(this.db); }
};

const QuizEngine = {
    activeQ: [], currIdx: 0, currCat: null, isFiltered: false,
    start(c) {
        const raw = DataManager.db[c];
        if (!raw || !raw.length) { alert("Vac√≠o"); return; }
        this.currCat = c;
        const s = localStorage.getItem('SESSION_'+c);
        if(s) { 
            try { 
                const d = JSON.parse(s); this.activeQ = d.q; this.currIdx = d.idx; 
                this.isFiltered = d.isFiltered || false; this.applyFilter();
            } catch(e) { this.initSession(c); } 
        } else this.initSession(c);
        App.showScreen('screen-quiz'); this.render();
    },
    initSession(c) {
        this.activeQ = DataManager.db[c].map((q, i) => ({
            ...q, dbIdx: i, shuffledOpts: q.opts.map((o, k) => ({...o, oid: k})).sort(()=>Math.random()-0.5),
            status: 'pending', userSel: [], flagged: false, skipped: false
        })).sort(()=>Math.random()-0.5);
        this.currIdx = 0; this.isFiltered = false; this.applyFilter(); this.save();
    },
    applyFilter() {
        this.activeQ.forEach(q => q.skipped = (this.isFiltered && q.img));
        if(this.activeQ[this.currIdx]?.skipped) this.goToNextAvailable();
    },
    toggleImgFilter() {
        this.isFiltered = !this.isFiltered; this.applyFilter(); this.save(); this.render();
    },
    goToNextAvailable() {
        for(let i=0; i<this.activeQ.length; i++) if(!this.activeQ[i].skipped) { this.currIdx = i; return; }
        alert("Filtro bloquea todo");
    },
    save() { localStorage.setItem('SESSION_'+this.currCat, JSON.stringify({q: this.activeQ, idx: this.currIdx, isFiltered: this.isFiltered})); },
    resetProgress() { if(confirm("¬øReiniciar?")) { localStorage.removeItem('SESSION_'+this.currCat); this.initSession(this.currCat); this.render(); } },
    render() {
        const fb = document.getElementById('btn-filter-img');
        if(this.isFiltered) { fb.innerHTML = "üìù SOLO TEXTO"; fb.classList.add('active'); } else { fb.innerHTML = "üëÅÔ∏è TODO"; fb.classList.remove('active'); }

        const q = this.activeQ[this.currIdx];
        if(!q) return;

        if(q.skipped) { this.goToNextAvailable(); if(this.activeQ[this.currIdx].skipped) return; this.render(); return; }

        document.getElementById('quiz-cat-name').innerText = this.currCat;
        document.getElementById('quiz-progress').innerText = `${this.currIdx+1} / ${this.activeQ.length}`;
        document.getElementById('quiz-question').innerText = q.t;
        document.getElementById('quiz-img-warn').style.display = q.img ? 'block' : 'none';
        
        const c = document.getElementById('quiz-options'); c.innerHTML = '';
        q.shuffledOpts.forEach((o, i) => {
            const d = document.createElement('div'); d.className = 'quiz-option'; d.innerText = o.t;
            if(q.status !== 'pending') {
                d.classList.add('disabled');
                if(o.c) d.classList.add('correct'); else if(q.userSel.includes(i)) d.classList.add('incorrect');
            } else if(q.userSel.includes(i)) d.classList.add('selected');
            
            d.onclick = () => { 
                if(q.status!=='pending') return;
                const x = q.userSel.indexOf(i); if(x>-1) q.userSel.splice(x, 1); else q.userSel.push(i); 
                this.render(); 
            };
            c.appendChild(d);
        });

        const btn = document.getElementById('btn-action'); 
        btn.onclick = null;
        if(q.status === 'pending') {
            btn.innerText = "CONFIRMAR"; btn.className = "btn btn-primary";
            btn.onclick = () => {
                const ok = q.userSel.length && q.userSel.every(x => q.shuffledOpts[x].c) && q.userSel.length === q.shuffledOpts.filter(o=>o.c).length;
                q.status = ok ? 'correct' : 'incorrect';
                if(ok) {
                    const pending = this.activeQ.some(x => !x.skipped && x.status !== 'correct');
                    if(!pending) { this.currIdx = this.activeQ.length-1; this.save(); alert("¬°FIN!"); App.goHome(); return; }
                } else q.flagged = true;
                this.save(); this.render();
            };
        } else if(q.status === 'correct') {
            btn.innerText = "SIGUIENTE"; btn.className = "btn btn-default";
            btn.onclick = () => {
                let next = -1;
                for(let i=this.currIdx+1; i<this.activeQ.length; i++) {
                    if(this.activeQ[i].status !== 'correct' && !this.activeQ[i].skipped) { next = i; break; }
                }
                if(next !== -1) { this.currIdx = next; this.save(); this.render(); }
                else { this.currIdx = this.activeQ.length-1; this.save(); alert("¬°FIN!"); App.goHome(); }
            }
        } else {
            btn.innerText = "REINTENTAR"; btn.className = "btn btn-danger";
            btn.onclick = () => { q.status = 'pending'; q.userSel = []; this.save(); this.render(); };
        }

        document.getElementById('stat-ok').innerText = this.activeQ.filter(x=>x.status==='correct').length;
        document.getElementById('stat-fail').innerText = this.activeQ.filter(x=>x.status==='incorrect').length;

        const g = document.getElementById('nav-grid'); g.innerHTML = '';
        this.activeQ.forEach((x, i) => {
            const d = document.createElement('div'); d.className = 'grid-item'; d.innerText = i+1;
            if(x.skipped) d.classList.add('skipped');
            else {
                if(i === this.currIdx) d.classList.add('active');
                if(x.status === 'correct') d.classList.add('correct');
                if(x.status === 'incorrect') d.classList.add('incorrect');
                d.onclick = () => { this.currIdx = i; this.save(); this.render(); };
            }
            g.appendChild(d);
        });
    }
};

const Editor = {
    createCategory() { const n = document.getElementById('new-cat-input').value.trim(); if(n) { DataManager.createCat(n); this.renderCats(); } },
    renderCats() {
        const c = document.getElementById('editor-cat-list'); c.innerHTML = '';
        const t = document.getElementById('import-target'); t.innerHTML = '<option value="__AUTO__">DETECTAR AUTO</option>';
        DataManager.getCats().forEach(n => {
            const d = document.createElement('div'); 
            d.innerHTML = `<div style="display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;"><span>${n}</span> <button style="background:transparent; border:none; color:#ff7675; font-weight:bold;" onclick="DataManager.deleteCat('${n}'); Editor.renderCats()">X</button></div>`;
            c.appendChild(d);
            const o = document.createElement('option'); o.value = n; o.innerText = n; t.appendChild(o);
        });
    },
    processBulk() {
        const t = document.getElementById('import-target').value;
        const v = document.getElementById('bulk-input').value;
        if(v && DataManager.importJSON(t, v)) { alert("OK"); this.renderCats(); }
    }
};

const App = {
    init() { DataManager.init(); this.goHome(); },
    goHome() {
        this.showScreen('screen-home');
        const c = document.getElementById('home-cat-list'); c.innerHTML = '';
        const cats = DataManager.getCats();
        if(!cats.length) c.innerHTML = "<div style='text-align:center; color:#666;'>Sin datos</div>";
        cats.forEach(n => {
            const s = localStorage.getItem('SESSION_'+n);
            let cl = 'st-grey', tx = 'SIN EMPEZAR';
            if(s) { 
                try { 
                    const d=JSON.parse(s); 
                    const vis = d.q.filter(x => !x.skipped);
                    if(vis.length && vis.every(q => q.status === 'correct')) { cl='st-green'; tx='ACABADO'; }
                    else if(d.q.some(x => x.status!=='pending')) { cl='st-yellow'; tx='EN PROCESO'; }
                } catch(e){} 
            }
            const div = document.createElement('div'); div.className='cat-card';
            div.innerHTML = `<div class="cat-name">${n}</div><div class="cat-status-badge ${cl}"><span class="status-dot"></span> ${tx}</div>`;
            div.onclick = () => QuizEngine.start(n); c.appendChild(div);
        });
    },
    showEditor() { this.showScreen('screen-editor'); Editor.renderCats(); },
    showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
};
App.init();
</script>
</body>
</html>

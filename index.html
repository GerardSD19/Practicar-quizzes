<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRACTICAR QUIZZES M√íBIL // GERARD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e2024 0%, #23252b 100%);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --text-main: #e0e0e0;
            --text-muted: #9ca3af;
            --text-highlight: #ffffff;
            --accent-primary: #6c5ce7; 
            --accent-success: #00b894;
            --accent-danger: #ff7675;
            --accent-warning: #fdcb6e;
            --radius-md: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            min-height: 100vh;
            padding: 20px 10px 60px 10px; 
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
            font-size: 14px;
        }

        /* --- PANELES --- */
        .panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            box-shadow: var(--glass-shadow);
            display: flex; 
            flex-direction: column;
            margin-bottom: 15px;
            overflow: visible; 
        }

        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; padding: 0 5px;
        }
        .app-title { font-weight: 800; font-size: 1rem; color: var(--text-highlight); }

        /* --- BOTONES --- */
        .btn {
            border: none; padding: 14px; cursor: pointer;
            border-radius: var(--radius-md);
            font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.9rem;
            text-transform: uppercase; width: 100%; transition: 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-default { background: rgba(255,255,255,0.1); color: white; }
        .btn-primary { background: var(--accent-primary); color: white; }
        .btn-danger { background: rgba(255, 118, 117, 0.15); color: var(--accent-danger); border: 1px solid rgba(255, 118, 117, 0.3); }

        .btn-icon {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted); border-radius: 8px; padding: 8px 12px;
            font-family: 'Montserrat', sans-serif; font-size: 0.75rem; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.2); color: white; }
        .btn-icon.del { color: var(--accent-danger); border-color: rgba(255, 118, 117, 0.3); }

        .filter-toggle {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 8px 12px;
            font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
            display: flex; align-items: center; gap: 6px; cursor: pointer;
        }
        .filter-toggle.active {
            background: var(--accent-warning); color: #1e2024; border-color: var(--accent-warning);
        }

        /* --- HOME --- */
        .cat-grid { display: grid; grid-template-columns: 1fr; gap: 12px; padding: 15px; }
        .cat-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: var(--radius-md); padding: 18px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 90px;
        }
        .cat-status-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 0.7rem; font-weight: 700; padding: 4px 10px; border-radius: 20px; background: rgba(0,0,0,0.3); width: fit-content; margin-top: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .st-grey .status-dot { background: #636e72; } .st-grey { color: #9ca3af; border: 1px solid #636e72; }
        .st-yellow .status-dot { background: var(--accent-warning); } .st-yellow { color: var(--accent-warning); border: 1px solid var(--accent-warning); }
        .st-green .status-dot { background: var(--accent-success); } .st-green { color: var(--accent-success); border: 1px solid var(--accent-success); }

        /* --- QUIZ --- */
        .quiz-container { display: flex; flex-direction: column; gap: 15px; }
        .question-text { font-size: 1.1rem; font-weight: 600; line-height: 1.45; color: white; margin-bottom: 20px; padding: 0 2px; }

        .quiz-option {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; padding: 12px 15px; margin-bottom: 8px;
            cursor: pointer; font-size: 0.95rem; line-height: 1.3;
            display: flex; align-items: center;
        }
        .quiz-option.selected { background: rgba(108, 92, 231, 0.25); border-color: var(--accent-primary); color: white; font-weight: 600; }
        .quiz-option.correct { background: rgba(0, 184, 148, 0.25); border-color: var(--accent-success); color: #55efc4; }
        .quiz-option.incorrect { background: rgba(255, 118, 117, 0.25); border-color: var(--accent-danger); color: #ff7675; }
        .quiz-option.disabled { opacity: 0.9; pointer-events: none; }

        /* --- NAV GRID --- */
        .nav-panel { padding: 15px; }
        .stats-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-box { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 8px; text-align: center; border-radius: 8px; }
        .stat-num { font-size: 1.4rem; font-weight: 800; display: block; }
        
        .nav-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(38px, 1fr)); gap: 6px; 
            max-height: 200px; overflow-y: auto;
        }
        .grid-item { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.85rem; color: #888; font-weight: 600; position: relative; }
        .grid-item.active { border: 2px solid white; color: white; background: transparent; }
        .grid-item.correct { background: var(--accent-success); color: black; border: none; }
        .grid-item.incorrect { background: var(--accent-danger); color: white; border: none; }
        .grid-item.skipped { background: #151515; color: #444; border: 1px solid #222; cursor: not-allowed; box-shadow: inset 0 0 5px rgba(0,0,0,0.8); }
        .grid-item.skipped:hover { transform: none; background: #151515; }

        .grid-item.was-failed::after {
            content: '!'; position: absolute; top: -4px; right: -4px; 
            background: var(--accent-warning); color: black;
            font-size: 10px; font-weight: 900; width: 16px; height: 16px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 1px solid black; z-index: 10;
        }

        /* --- EDITOR --- */
        .editor-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .tab-link { 
            background: transparent; border: none; color: var(--text-muted); padding: 6px 12px; 
            font-weight: 700; border-radius: 15px; font-family: 'Montserrat', sans-serif; font-size: 0.8rem;
        }
        .tab-link.active { background: rgba(255,255,255,0.15); color: white; }

        .cat-item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .q-row {
            background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;
        }
        
        input, textarea { font-size: 16px !important; } 
        
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <div class="top-bar">
            <div class="app-title">PRACTICAR QUIZZES M√íBIL <span style="font-weight:300; font-size:0.7em;">Gerard</span></div>
        </div>
        <div class="panel" style="padding: 15px;">
            <h2 style="text-align:center; margin-bottom:20px; font-size:1.3rem;">Categor√≠as</h2>
            <div id="home-cat-list" class="cat-grid"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-default" onclick="App.showEditor()">Gestionar</button>
                <button class="btn btn-danger" onclick="DataManager.nuke()">Reset</button>
            </div>
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="top-bar">
            <button class="btn btn-default" style="width:auto; padding: 8px 12px; font-size:0.7rem;" onclick="App.goHome()">SALIR</button>
            <button id="btn-filter-img" class="filter-toggle" onclick="QuizEngine.toggleImgFilter()"><span>üëÅÔ∏è</span> TODO</button>
        </div>

        <div class="quiz-container">
            <div class="panel" style="padding: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; color:var(--text-muted); font-size:0.75rem; font-weight:700;">
                    <span id="quiz-cat-name" style="max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">CAT</span>
                    <div style="text-align:right;">
                        <span id="quiz-history-flag" style="color:var(--accent-warning); margin-right:5px; display:none;">‚ö† REVISI√ìN</span>
                        <span id="quiz-progress">1/X</span>
                    </div>
                </div>
                
                <div id="quiz-img-warn" style="display:none; padding:10px; background:rgba(108,92,231,0.1); border:1px dashed var(--accent-primary); border-radius:8px; margin-bottom:15px; color:#a29bfe; font-size:0.85rem;">
                    üì∑ <strong>Ver PDF</strong>
                </div>

                <div id="quiz-question" class="question-text">...</div>
                <div id="quiz-options"></div>

                <div style="margin-top:20px;">
                    <button id="btn-action" class="btn btn-primary">CONFIRMAR</button>
                </div>
            </div>

            <div class="panel nav-panel">
                <div class="stats-row">
                    <div class="stat-box" style="border-color:rgba(0,184,148,0.3);"><span id="stat-ok" class="stat-num" style="color:var(--accent-success)">0</span></div>
                    <div class="stat-box" style="border-color:rgba(255,118,117,0.3);"><span id="stat-fail" class="stat-num" style="color:var(--accent-danger)">0</span></div>
                </div>
                <div id="nav-grid" class="nav-grid"></div>
                <button class="btn btn-danger" style="margin-top:15px; font-size:0.8rem; padding:10px;" onclick="QuizEngine.resetProgress()">REINICIAR</button>
            </div>
        </div>
    </div>

    <div id="screen-editor" class="screen">
        <div class="top-bar">
            <div class="app-title">GESTOR</div>
            <button class="btn btn-default" style="width:auto; padding:8px 12px;" onclick="App.goHome()">VOLVER</button>
        </div>
        <div class="panel" style="padding:15px;">
            <div class="editor-tabs">
                <button id="tab-manual-btn" class="tab-link active" onclick="Editor.switchTab('manual')">MANUAL</button>
                <button id="tab-bulk-btn" class="tab-link" onclick="Editor.switchTab('bulk')">JSON</button>
            </div>

            <div id="tab-manual">
                <div style="margin-bottom:15px;">
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <input type="text" id="new-cat-input" placeholder="Nueva Categor√≠a..." style="background:#222; border:1px solid #444; color:white; padding:10px; border-radius:8px; flex:1; margin:0;">
                        <button class="btn btn-default" style="width:auto;" onclick="Editor.createCategory()">+</button>
                    </div>
                    <div id="editor-cat-list" style="max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:5px;"></div>
                </div>
                
                <hr style="border:0; border-top:1px solid #333; margin:15px 0;">

                <div id="editor-main-col">
                    <button id="btn-toggle-form" class="btn btn-default" style="border:1px dashed #555; margin-bottom:10px; width:100%;" onclick="Editor.openNew()">+ PREGUNTA</button>
                    
                    <div id="form-container" style="background:#1a1a1a; padding:15px; border-radius:10px; border:1px solid #333; display:none; margin-bottom:15px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="font-weight:700; color:#888;">EDITAR</span>
                            <span id="target-cat" style="color:var(--accent-primary); font-size:0.8rem;"></span>
                        </div>
                        <textarea id="q-text" rows="3" placeholder="Enunciado..." style="width:100%; background:#222; color:white; border:1px solid #444; padding:10px; border-radius:8px; margin-bottom:10px;"></textarea>
                        <div id="q-options-container"></div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                            <button class="btn btn-default" style="font-size:0.7rem; width:auto; padding:6px 10px;" onclick="Editor.addOptionInput()">+ OPCI√ìN</button>
                            <label style="display:flex; align-items:center; gap:5px; color:#888; font-size:0.8rem;"><input type="checkbox" id="q-img-check"> Foto</label>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button id="btn-save-q" class="btn btn-primary" onclick="Editor.saveQuestion()">OK</button>
                            <button class="btn btn-danger" onclick="Editor.cancelEdit()">X</button>
                        </div>
                    </div>

                    <input type="text" id="search-q" placeholder="Buscar pregunta..." oninput="Editor.renderQuestionsList()" style="width:100%; margin-bottom:10px;">
                    <div id="editor-q-list" style="flex:1; overflow-y:auto; min-height:200px;"></div>
                </div>
            </div>

            <div id="tab-bulk" style="display:none;">
                <label style="display:block; margin-bottom:8px; font-weight:600; color:#888;">DESTINO:</label>
                <select id="import-target" style="width:100%; padding:10px; background:#222; color:white; border:1px solid #444; border-radius:8px; margin-bottom:10px;"></select>
                <textarea id="bulk-input" style="width:100%; height:250px; background:#111; border:1px solid #444; color:#a29bfe; padding:10px; border-radius:8px; font-family:monospace;" placeholder="[...]"></textarea>
                <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="Editor.processBulk()">IMPORTAR</button>
            </div>
        </div>
    </div>

<script>
// --- CORE LOGIC (SAFE VERSION) ---
const DataManager = {
    key: 'DB_QUIZ_V29', db: {},
    init: function() { 
        const r = localStorage.getItem(this.key); 
        if(r) { try { this.db = JSON.parse(r); } catch(e) { this.db = {}; } }
    },
    save: function() { localStorage.setItem(this.key, JSON.stringify(this.db)); },
    createCat: function(n) { if(!n || this.db[n]) return; this.db[n] = []; this.save(); },
    deleteCat: function(n) { if(confirm("¬øBorrar?")) { delete this.db[n]; localStorage.removeItem('SESSION_'+n); this.save(); } },
    importJSON: function(t, j) { 
        try { 
            const d = JSON.parse(j); 
            if(t==='__AUTO__' && Array.isArray(d)) d.forEach(function(x){ if(x.cat) DataManager.db[x.cat] = x.data; }); 
            else if(DataManager.db[t]) DataManager.db[t] = DataManager.db[t].concat(d); 
            this.save(); return true; 
        } catch(e){ alert("Error JSON"); return false; } 
    },
    nuke: function() { if(confirm("¬øReset Total?")) { localStorage.clear(); location.reload(); } },
    getCats: function() { return Object.keys(this.db); },
    updateQ: function(c, i, q) { this.db[c][i] = q; this.save(); QuizEngine.syncUpdate(c, i, q); },
    addQ: function(c, q) { this.db[c].push(q); this.save(); QuizEngine.syncAdd(c, q, this.db[c].length-1); },
    deleteQ: function(c, i) { this.db[c].splice(i, 1); this.save(); QuizEngine.syncRemove(c, i); }
};

const QuizEngine = {
    activeQ: [], currIdx: 0, currCat: null, isFiltered: false,
    start: function(c) {
        if(!DataManager.db[c] || !DataManager.db[c].length) { alert("Vac√≠o"); return; }
        this.currCat = c;
        const s = localStorage.getItem('SESSION_'+c);
        if(s) { 
            try { 
                const d=JSON.parse(s); this.activeQ=d.q; this.currIdx=d.idx; this.isFiltered=d.isFiltered||false; this.applyFilter(); 
                if(!this.activeQ.length) throw "e";
            } catch(e){ this.initSession(c); } 
        } 
        else this.initSession(c);
        App.showScreen('screen-quiz'); this.render();
    },
    initSession: function(c) {
        this.activeQ = DataManager.db[c].map(function(q, i) {
            return { ...q, dbIdx: i, shuffledOpts: q.opts.map(function(o,k){ return {...o, oid:k}; }).sort(function(){return Math.random()-0.5}), status:'pending', userSel:[], flagged:false, skipped:false };
        }).sort(function(){return Math.random()-0.5});
        this.currIdx = 0; this.isFiltered = false; this.applyFilter(); this.save();
    },
    applyFilter: function() {
        var that = this;
        this.activeQ.forEach(function(q) { q.skipped = (that.isFiltered && q.img); });
        if(this.activeQ[this.currIdx] && this.activeQ[this.currIdx].skipped) this.goToNextAvailable();
    },
    toggleImgFilter: function() { this.isFiltered = !this.isFiltered; this.applyFilter(); this.save(); this.render(); },
    goToNextAvailable: function() {
        for(let i=0; i<this.activeQ.length; i++) if(!this.activeQ[i].skipped) { this.currIdx = i; return; }
        alert("Filtro bloquea todo");
    },
    save: function() { if(this.currCat) localStorage.setItem('SESSION_'+this.currCat, JSON.stringify({q: this.activeQ, idx: this.currIdx, isFiltered: this.isFiltered})); },
    
    // Sync functions
    syncAdd: function(c, q, i) { const k='SESSION_'+c, s=localStorage.getItem(k); if(!s) return; const d=JSON.parse(s); d.q.push({...q, dbIdx: i, shuffledOpts: q.opts.map(function(o,k){return {...o, oid:k}}).sort(function(){return Math.random()-0.5}), status:'pending', userSel:[], flagged:false, skipped:false}); localStorage.setItem(k, JSON.stringify(d)); },
    syncUpdate: function(c, i, q) {
        const k='SESSION_'+c, s=localStorage.getItem(k); if(!s) return; const d=JSON.parse(s); const h=d.q.find(function(x){return x.dbIdx===i});
        if(h) { const fin = d.idx >= d.q.length-1; h.t=q.t; h.img=q.img; h.opts=q.opts; h.shuffledOpts=q.opts.map(function(o,k){return {...o, oid:k}}).sort(function(){return Math.random()-0.5}); h.status='pending'; h.userSel=[]; h.flagged=false; h.skipped=d.isFiltered && h.img; if(fin) { d.idx=d.q.indexOf(h); if(d.idx>=d.q.length-1) d.idx--; } localStorage.setItem(k, JSON.stringify(d)); }
    },
    syncRemove: function(c, i) {
        const k='SESSION_'+c, s=localStorage.getItem(k); if(!s) return;
        const d=JSON.parse(s); d.q=d.q.filter(function(x){return x.dbIdx!==i}); d.q.forEach(function(x){if(x.dbIdx>i)x.dbIdx--}); if(d.idx>=d.q.length) d.idx=Math.max(0, d.q.length-1); localStorage.setItem(k, JSON.stringify(d));
    },
    resetProgress: function() { if(confirm("¬øReiniciar?")) { localStorage.removeItem('SESSION_'+this.currCat); this.initSession(this.currCat); this.render(); } },
    
    render: function() {
        const fb = document.getElementById('btn-filter-img');
        if(this.isFiltered) { fb.innerHTML="üìù SOLO TEXTO"; fb.classList.add('active'); } else { fb.innerHTML="üëÅÔ∏è TODO"; fb.classList.remove('active'); }
        
        if(!this.activeQ[this.currIdx]) { if(this.activeQ.length > 0) this.currIdx = 0; else return; }
        const q = this.activeQ[this.currIdx];
        if(q.skipped) { this.goToNextAvailable(); if(this.activeQ[this.currIdx].skipped) return; this.render(); return; }

        document.getElementById('quiz-cat-name').innerText = this.currCat;
        document.getElementById('quiz-progress').innerText = (this.currIdx+1) + " / " + this.activeQ.length;
        document.getElementById('quiz-question').innerText = q.t;
        document.getElementById('quiz-img-warn').style.display = q.img ? 'block' : 'none';
        
        const hFlag = document.getElementById('quiz-history-flag');
        hFlag.style.display = q.flagged ? 'inline' : 'none';

        const c = document.getElementById('quiz-options'); c.innerHTML = '';
        var that = this;
        q.shuffledOpts.forEach(function(o, i) {
            const d = document.createElement('div'); d.className = 'quiz-option'; d.innerText = o.t;
            if(q.status !== 'pending') {
                d.classList.add('disabled');
                if(o.c) d.classList.add('correct'); else if(q.userSel.includes(i)) d.classList.add('incorrect');
            } else if(q.userSel.includes(i)) d.classList.add('selected');
            
            d.onclick = function() { 
                if(q.status!=='pending') return;
                const x=q.userSel.indexOf(i); if(x>-1)q.userSel.splice(x,1); else q.userSel.push(i); that.render(); 
            };
            c.appendChild(d);
        });

        const btn = document.getElementById('btn-action'); btn.onclick = null;
        if(q.status === 'pending') {
            btn.innerText = "CONFIRMAR"; btn.className = "btn btn-primary";
            btn.onclick = function() {
                const ok = q.userSel.length && q.userSel.every(function(x){return q.shuffledOpts[x].c}) && q.userSel.length === q.shuffledOpts.filter(function(o){return o.c}).length;
                q.status = ok ? 'correct' : 'incorrect';
                if(ok) {
                    const pending = that.activeQ.some(function(x){ return !x.skipped && x.status !== 'correct'});
                    if(!pending) { that.currIdx = that.activeQ.length-1; that.save(); alert("¬°FIN!"); App.goHome(); return; }
                } else { q.flagged = true; } 
                that.save(); that.render();
            };
        } else if(q.status === 'correct') {
            btn.innerText = "SIGUIENTE"; btn.className = "btn btn-default";
            btn.onclick = function() {
                let next = -1;
                for(let i=that.currIdx+1; i<that.activeQ.length; i++) if(that.activeQ[i].status !== 'correct' && !that.activeQ[i].skipped) { next = i; break; }
                if(next !== -1) { that.currIdx = next; that.save(); that.render(); } else { that.currIdx=that.activeQ.length-1; that.save(); alert("¬°FIN!"); App.goHome(); }
            };
        } else {
            btn.innerText = "REINTENTAR"; btn.className = "btn btn-danger";
            btn.onclick = function() { q.status = 'pending'; q.userSel = []; that.save(); that.render(); };
        }

        document.getElementById('stat-ok').innerText = this.activeQ.filter(function(x){return x.status==='correct'}).length;
        document.getElementById('stat-fail').innerText = this.activeQ.filter(function(x){return x.status==='incorrect'}).length;

        const g = document.getElementById('nav-grid'); g.innerHTML = '';
        this.activeQ.forEach(function(x, i) {
            const d = document.createElement('div'); d.className = 'grid-item'; d.innerText = i+1;
            if(x.skipped) d.classList.add('skipped');
            else {
                if(i === that.currIdx) d.classList.add('active');
                if(x.status === 'correct') d.classList.add('correct');
                if(x.status === 'incorrect') d.classList.add('incorrect');
                if(x.flagged) d.classList.add('was-failed'); 
                d.onclick = function() { that.currIdx = i; that.save(); that.render(); };
            }
            g.appendChild(d);
        });
    }
};

const Editor = {
    selCat: null, editIdx: null,
    createCategory: function() { const n = document.getElementById('new-cat-input').value.trim(); if(n) { DataManager.createCat(n); this.renderCats(); } },
    renderCats: function() {
        const c = document.getElementById('editor-cat-list'); c.innerHTML = '';
        const t = document.getElementById('import-target'); t.innerHTML = '<option value="__AUTO__">DETECTAR AUTO</option>';
        var that = this;
        DataManager.getCats().forEach(function(n) {
            const d = document.createElement('div'); d.className = 'cat-item-row';
            if(that.selCat===n) d.classList.add('active');
            d.innerHTML = '<span>'+n+'</span> <div style="display:flex; gap:5px;"><button class="btn-icon del" onclick="event.stopPropagation();DataManager.deleteCat(\''+n+'\');Editor.renderCats()">X</button></div>';
            d.onclick = function() { that.selectCat(n); };
            c.appendChild(d);
            const o = document.createElement('option'); o.value = n; o.innerText = n; t.appendChild(o);
        });
    },
    selectCat: function(n) { this.selCat=n; document.getElementById('target-cat').innerText=n; this.cancelEdit(); this.renderQuestionsList(); },
    renderQuestionsList: function() {
        const c=document.getElementById('editor-q-list'); c.innerHTML=''; const s=document.getElementById('search-q').value.toLowerCase();
        if(!this.selCat) return;
        var that = this;
        DataManager.db[this.selCat].forEach(function(q,i) {
            if(s && !q.t.toLowerCase().includes(s)) return;
            const d=document.createElement('div'); d.className='q-row';
            d.innerHTML='<div class="q-text-full"><b>'+(i+1)+'.</b> '+q.t+'</div><div style="display:flex;gap:5px;"><button class="btn-icon" onclick="Editor.loadQ('+i+')">E</button><button class="btn-icon del" onclick="if(confirm(\'?\')){DataManager.deleteQ(\''+that.selCat+'\','+i+');Editor.renderQuestionsList();}">X</button></div>';
            c.appendChild(d);
        });
    },
    switchTab: function(t) {
        document.getElementById('tab-manual').style.display=t==='manual'?'block':'none';
        document.getElementById('tab-bulk').style.display=t==='bulk'?'block':'none';
        document.querySelectorAll('.tab-link').forEach(function(b){b.classList.remove('active')});
        document.getElementById('tab-'+t+'-btn').classList.add('active');
        if(t==='manual') this.renderCats();
    },
    addOptionInput: function(v='', c=false) {
        const d=document.createElement('div'); d.style.cssText="display:flex; gap:5px; margin-bottom:5px;";
        d.innerHTML='<input type="checkbox" style="width:20px;margin:0;" '+(c?'checked':'')+'><input type="text" value="'+v.replace(/"/g,'&quot;')+'" style="flex:1;margin:0; background:#333; border:1px solid #555; color:white; padding:8px; border-radius:6px;"><button class="btn-icon del" onclick="this.parentElement.remove()">X</button>';
        document.getElementById('q-options-container').appendChild(d);
    },
    openNew: function() { if(!this.selCat){alert("Elige Categor√≠a");return;} this.editIdx=null; this.resetInputs(); document.getElementById('form-container').style.display='block'; document.getElementById('btn-toggle-form').style.display='none'; },
    loadQ: function(i) { this.editIdx=i; const q=DataManager.db[this.selCat][i]; document.getElementById('form-container').style.display='block'; document.getElementById('btn-toggle-form').style.display='none'; document.getElementById('q-text').value=q.t; document.getElementById('q-img-check').checked=q.img; document.getElementById('q-options-container').innerHTML=''; var that=this; q.opts.forEach(function(o){that.addOptionInput(o.t,o.c)}); },
    saveQuestion: function() {
        if(!this.selCat) return;
        const t = document.getElementById('q-text').value; const opts = [];
        document.querySelectorAll('#q-options-container > div').forEach(function(d) {
            const txt = d.querySelector('input[type=text]').value.trim(); const chk = d.querySelector('input[type=checkbox]').checked;
            if(txt) opts.push({t: txt, c: chk});
        });
        if(!t || opts.length < 2) { alert("Faltan datos"); return; }
        const q = { t, opts, img: document.getElementById('q-img-check').checked };
        if(this.editIdx !== null) DataManager.updateQ(this.selCat, this.editIdx, q); else DataManager.addQ(this.selCat, q);
        this.cancelEdit(); this.renderQuestionsList();
    },
    cancelEdit: function() { this.editIdx=null; document.getElementById('form-container').style.display='none'; document.getElementById('btn-toggle-form').style.display='block'; },
    resetInputs: function() { document.getElementById('q-text').value=''; document.getElementById('q-options-container').innerHTML=''; this.addOptionInput(); this.addOptionInput(); },
    updateBulkPlaceholder: function() { const v=document.getElementById('import-target').value; document.getElementById('bulk-input').placeholder = v==='__AUTO__' ? 'JSON Completo...' : 'Array Preguntas...'; },
    processBulk: function() { const t=document.getElementById('import-target').value; const v=document.getElementById('bulk-input').value; if(v && DataManager.importJSON(t,v)) { alert("OK"); this.renderCats(); } }
};

const App = {
    init: function() { DataManager.init(); this.goHome(); },
    goHome: function() {
        this.showScreen('screen-home');
        const c = document.getElementById('home-cat-list'); c.innerHTML = '';
        const cats = DataManager.getCats();
        if(!cats.length) c.innerHTML = "<div style='text-align:center; color:#666;'>Sin datos</div>";
        var that = this;
        cats.forEach(function(n) {
            const s = localStorage.getItem('SESSION_'+n);
            let cl = 'st-grey', tx = 'SIN EMPEZAR';
            if(s) { 
                try { 
                    const d=JSON.parse(s); 
                    const vis = d.q.filter(function(x){return !x.skipped});
                    if(vis.length && vis.every(function(q){return q.status === 'correct'})) { cl='st-green'; tx='ACABADO'; }
                    else if(d.q.some(function(x){return x.status!=='pending'})) { cl='st-yellow'; tx='EN PROCESO'; }
                } catch(e){} 
            }
            const div = document.createElement('div'); div.className='cat-card';
            div.innerHTML = '<div class="cat-name">'+n+'</div><div class="cat-status-badge '+cl+'"><span class="status-dot"></span> '+tx+'</div>';
            div.onclick = function() { QuizEngine.start(n); };
            c.appendChild(div);
        });
    },
    showEditor: function() { this.showScreen('screen-editor'); Editor.switchTab('manual'); },
    showScreen: function(id) { document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')}); document.getElementById(id).classList.add('active'); }
};
App.init();
</script>
</body>
</html>

